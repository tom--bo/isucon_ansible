- hosts: isucon_server
  become: yes
  vars:
    isuconuser: isucon
  tasks:

    - include: ubuntu.yml
      when: ansible_os_family == "Debian"

    - include: redhat.yml
      when: "ansible_os_family == 'RedHat'"

    - name: check isucon user exists ?
      stat: path=/home/isucon
      register: isucon_exist

    - name: Add group isucon
      group: name={{isuconuser}}
      when: not isucon_exist.stat.exists

    - name: Add user isucon for Ubuntu
      user: name={{ isuconuser }} shell=/bin/zsh group=sudo
      when: not isucon_exist.stat.exists and ansible_os_family == "Debian"

    - name: Add user isucon for RedHat
      user: name={{ isuconuser }} shell=/bin/zsh group=root
      when: not isucon_exist.stat.exists and ansible_os_family == "RedHat"

    - name: (temporary) copy dotfiles to isucon user
      copy: >
        src=dotfiles
        dest=/home/{{ isuconuser }}
        owner={{ isuconuser }}
        mode=0755

    - name: Set up isucon
      copy: >
        src=submodules/settings
        dest=/home/{{ isuconuser }}
        owner={{ isuconuser }}
        mode=0755


    - name: Change default shell to zsh
      user: name={{ isuconuser }} shell=/bin/zsh

    - name: check .zshrc exists ?
      stat: path=/home/isucon/.zshrc
      register: zshrc_exist

    - name: Delete .zshrc if exist
      file: path=/home/isucon/.zshrc state=absent
      when: zshrc_exist.stat.exists

    - name: (temporary) set zshrc file
      file: >
        src=/home/{{ isuconuser }}/dotfiles/zshrc
        dest=/home/{{ isuconuser }}/.zshrc
        owner={{ isuconuser }}
        state=link

    - name: check .zprofile exists ?
      stat: path=/home/isucon/.zprofile
      register: zprofile_exist

    - name: Delete .zprofile if exist
      file: path=/home/isucon/.zprofile state=absent
      when: zprofile_exist.stat.exists

    - name: (temporary) set zprofile file
      file: >
        src=/home/{{ isuconuser }}/dotfiles/zprofile
        dest=/home/{{ isuconuser }}/.zprofile
        owner={{ isuconuser }}
        state=link

    - name: (temporary) set vimrc file
      file: >
        src=/home/{{ isuconuser }}/dotfiles/vimrc
        dest=/home/{{ isuconuser }}/.vimrc
        owner={{ isuconuser }}
        state=link

    - name: (temporary) set tmux file
      file: >
        src=/home/{{ isuconuser }}/dotfiles/tmux.conf
        dest=/home/{{ isuconuser }}/.tmux.conf
        owner={{ isuconuser }}
        state=link



